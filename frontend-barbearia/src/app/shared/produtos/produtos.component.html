<div class="produtos-container">
  <!-- Header com Tabs -->
  <div class="header">
    <div class="header-left">
      <h1>💼 Gestão de Serviços</h1>
      <div class="tabs">
        <button 
          class="tab"
          [class.active]="abaAtiva === 'servicos'"
          (click)="mudarAba('servicos')">
          Serviços
        </button>
        <button 
          class="tab"
          [class.active]="abaAtiva === 'categorias'"
          (click)="mudarAba('categorias')">
          Categorias
        </button>
      </div>
    </div>
    <button 
      class="btn btn-primary" 
      (click)="abaAtiva === 'servicos' ? abrirModalNovoServico() : abrirModalNovaCategoria()">
      <span class="icon">➕</span>
      {{ abaAtiva === 'servicos' ? 'Novo Serviço' : 'Nova Categoria' }}
    </button>
  </div>

  <!-- Mensagens -->
  <div class="mensagem sucesso" *ngIf="sucesso">
    ✅ {{ sucesso }}
  </div>

  <div class="mensagem erro" *ngIf="erro && !mostrarModalServico && !mostrarModalCategoria">
    ❌ {{ erro }}
  </div>

  <!-- ==================== ABA SERVIÇOS ==================== -->
  <div *ngIf="abaAtiva === 'servicos'">
    <!-- Filtros -->
    <div class="filtros-container">
      <div class="busca-box">
        <span class="icone-busca">🔍</span>
        <input 
          type="text" 
          [(ngModel)]="termoBuscaServico" 
          (input)="aplicarFiltrosServicos(); paginaAtualServicos = 1"
          placeholder="Buscar serviços por nome, descrição ou categoria..."
          class="input-busca">
        <button class="btn-limpar" (click)="limparFiltrosServicos()" *ngIf="termoBuscaServico">✖</button>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="carregando && servicos.length === 0">
      <div class="spinner"></div>
      <p>Carregando serviços...</p>
    </div>

    <!-- Grid de Serviços -->
    <div class="servicos-grid" *ngIf="!carregando || servicos.length > 0">
      <div class="servico-card" *ngFor="let produto of servicosPaginados">
        <div class="servico-imagem">
          <img [src]="produto.foto_url || 'https://via.placeholder.com/300x200?text=Sem+Imagem'" 
               [alt]="produto.nome"
               (error)="onImageError($event)">
          <div class="servico-status" [class.inativo]="!produto.ativo">
            {{ produto.ativo ? 'Ativo' : 'Inativo' }}
          </div>
        </div>
        
        <div class="servico-info">
          <span class="servico-categoria" *ngIf="produto.categoria_nome">
            {{ produto.categoria_nome }}
          </span>
          <h3 class="servico-nome">{{ produto.nome }}</h3>
          <p class="servico-descricao" *ngIf="produto.descricao">
            {{ produto.descricao }}
          </p>
          
          <div class="servico-detalhes">
            <div class="preco-container">
              <span class="preco-label">Preço</span>
              <span class="preco">R$ {{ formatarPreco(produto.preco) }}</span>
            </div>
          </div>
        </div>

        <div class="servico-acoes">
          <button class="btn-acao editar" (click)="abrirModalEditarServico(produto)" title="Editar">
            ✏️
          </button>
          <button 
            class="btn-acao status" 
            [class.ativo]="produto.ativo"
            (click)="alternarStatusProduto(produto)" 
            [title]="produto.ativo ? 'Desativar' : 'Ativar'">
            {{ produto.ativo ? '👁️' : '🚫' }}
          </button>
          <button class="btn-acao excluir" (click)="confirmarExclusaoServico(produto)" title="Excluir">
            🗑️
          </button>
        </div>
      </div>
    </div>

    <!-- Sem resultados -->
    <div class="sem-resultados" *ngIf="servicosPaginados.length === 0 && !carregando">
      <span class="icone">📭</span>
      <h3>Nenhum serviço encontrado</h3>
      <p *ngIf="termoBuscaServico">Tente ajustar os filtros de busca</p>
      <p *ngIf="!termoBuscaServico">Clique em "Novo Serviço" para cadastrar</p>
    </div>

    <!-- Paginação -->
    <div class="paginacao" *ngIf="totalPaginasServicos > 1">
      <button 
        class="btn-pagina"
        [disabled]="paginaAtualServicos === 1"
        (click)="paginaAtualServicos = paginaAtualServicos - 1">
        ‹
      </button>

      <span class="pagina-info">
        Página {{ paginaAtualServicos }} de {{ totalPaginasServicos }}
      </span>

      <button 
        class="btn-pagina"
        [disabled]="paginaAtualServicos === totalPaginasServicos"
        (click)="paginaAtualServicos = paginaAtualServicos + 1">
        ›
      </button>
    </div>
  </div>

  <!-- ==================== ABA CATEGORIAS ==================== -->
  <div *ngIf="abaAtiva === 'categorias'">
    <!-- Filtros -->
    <div class="filtros-container">
      <div class="busca-box">
        <span class="icone-busca">🔍</span>
        <input 
          type="text" 
          [(ngModel)]="termoBuscaCategoria" 
          (input)="aplicarFiltrosCategorias(); paginaAtualCategorias = 1"
          placeholder="Buscar categorias por nome ou descrição..."
          class="input-busca">
        <button class="btn-limpar" (click)="limparFiltrosCategorias()" *ngIf="termoBuscaCategoria">✖</button>
      </div>
    </div>

    <!-- Tabela de Categorias -->
    <div class="table-container">
      <table class="categorias-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Status</th>
            <th>Cadastrado em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let categoria of categoriasPaginadas">
            <td class="categoria-nome">{{ categoria.nome }}</td>
            <td>{{ categoria.descricao || '-' }}</td>
            <td>
              <span class="badge" [class.ativo]="categoria.ativo" [class.inativo]="!categoria.ativo">
                {{ categoria.ativo ? 'Ativo' : 'Inativo' }}
              </span>
            </td>
            <td>{{ formatarData(categoria.criado_em!) }}</td>
            <td>
              <div class="acoes">
                <button class="btn-acao editar" (click)="abrirModalEditarCategoria(categoria)" title="Editar">
                  ✏️
                </button>
                <button class="btn-acao excluir" (click)="confirmarExclusaoCategoria(categoria)" title="Excluir">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Sem resultados -->
      <div class="sem-resultados" *ngIf="categoriasPaginadas.length === 0">
        <span class="icone">📭</span>
        <h3>Nenhuma categoria encontrada</h3>
        <p *ngIf="termoBuscaCategoria">Tente ajustar os filtros de busca</p>
        <p *ngIf="!termoBuscaCategoria">Clique em "Nova Categoria" para cadastrar</p>
      </div>
    </div>

    <!-- Paginação -->
    <div class="paginacao" *ngIf="totalPaginasCategorias > 1">
      <button 
        class="btn-pagina"
        [disabled]="paginaAtualCategorias === 1"
        (click)="paginaAtualCategorias = paginaAtualCategorias - 1">
        ‹
      </button>

      <span class="pagina-info">
        Página {{ paginaAtualCategorias }} de {{ totalPaginasCategorias }}
      </span>

      <button 
        class="btn-pagina"
        [disabled]="paginaAtualCategorias === totalPaginasCategorias"
        (click)="paginaAtualCategorias = paginaAtualCategorias + 1">
        ›
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL SERVIÇO ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalServico" (click)="fecharModais()">
  <div class="modal-conteudo modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editandoServico ? '✏️ Editar Serviço' : '➕ Novo Serviço' }}</h2>
      <button class="btn-fechar" (click)="fecharModais()">×</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ❌ {{ erro }}
      </div>

      <div class="form-linha">
        <div class="form-grupo col-2">
          <label>Nome do Serviço *</label>
          <input 
            type="text" 
            [(ngModel)]="formularioServico.nome"
            placeholder="Ex: Corte Degradê"
            required>
        </div>

        <div class="form-grupo">
          <label>Categoria</label>
          <select [(ngModel)]="formularioServico.categoria_id">
            <option [value]="undefined">Sem categoria</option>
            <option *ngFor="let cat of categorias" [value]="cat.id">
              {{ cat.nome }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-grupo">
        <label>Descrição</label>
        <textarea 
          [(ngModel)]="formularioServico.descricao"
          rows="3"
          placeholder="Descrição detalhada do serviço..."></textarea>
      </div>

      <div class="form-linha">
        <div class="form-grupo">
          <label>Preço (R$) *</label>
          <input 
            type="number" 
            [(ngModel)]="formularioServico.preco"
            min="0"
            step="0.01"
            placeholder="0,00"
            required>
        </div>

        <div class="form-grupo" *ngIf="editandoServico">
          <label>Status</label>
          <select [(ngModel)]="formularioServico.ativo">
            <option [value]="true">Ativo</option>
            <option [value]="false">Inativo</option>
          </select>
        </div>
      </div>

      <div class="form-grupo">
        <label>URL da Foto (opcional)</label>
        <input 
          type="text" 
          [(ngModel)]="formularioServico.foto_url"
          placeholder="https://exemplo.com/imagem.jpg">
        <small>Cole o link de uma imagem para o serviço</small>
      </div>

      <div class="preview-imagem" *ngIf="formularioServico.foto_url">
        <label>Preview:</label>
        <img 
          [src]="formularioServico.foto_url" 
          alt="Preview"
          (error)="onImageError($event)">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarServico()" [disabled]="carregando">
        {{ carregando ? 'Salvando...' : (editandoServico ? 'Salvar Alterações' : 'Cadastrar Produto') }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL CATEGORIA ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalCategoria" (click)="fecharModais()">
  <div class="modal-conteudo" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editandoCategoria ? '✏️ Editar Categoria' : '➕ Nova Categoria' }}</h2>
      <button class="btn-fechar" (click)="fecharModais()">×</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ❌ {{ erro }}
      </div>

      <div class="form-grupo">
        <label>Nome da Categoria *</label>
        <input 
          type="text" 
          [(ngModel)]="formularoCategoria.nome"
          placeholder="Ex: Cortes de Cabelo"
          required>
      </div>

      <div class="form-grupo">
        <label>Descrição</label>
        <textarea 
          [(ngModel)]="formularoCategoria.descricao"
          rows="3"
          placeholder="Descrição da categoria..."></textarea>
      </div>

      <div class="form-grupo" *ngIf="editandoCategoria">
        <label>Status</label>
        <select [(ngModel)]="formularoCategoria.ativo">
          <option [value]="true">Ativo</option>
          <option [value]="false">Inativo</option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarCategoria()" [disabled]="carregando">
        {{ carregando ? 'Salvando...' : (editandoCategoria ? 'Salvar Alterações' : 'Cadastrar Categoria') }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL Excluir Serviço ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalExcluirServico" (click)="fecharModais()">
  <div class="modal-conteudo modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>⚠️ Confirmar Exclusão</h2>
      <button class="btn-fechar" (click)="fecharModais()">×</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ❌ {{ erro }}
      </div>

      <p>Tem certeza que deseja excluir o serviço:</p>
      <p class="nome-destaque">{{ servicoSelecionado?.nome }}</p>
      <p class="aviso">Esta ação irá desativar o serviço no sistema.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="excluirProduto()" [disabled]="carregando">
        {{ carregando ? 'Excluindo...' : 'Confirmar Exclusão' }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL EXCLUIR CATEGORIA ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalExcluirCategoria" (click)="fecharModais()">
  <div class="modal-conteudo modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>⚠️ Confirmar Exclusão</h2>
      <button class="btn-fechar" (click)="fecharModais()">×</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ❌ {{ erro }}
      </div>

      <p>Tem certeza que deseja excluir a categoria:</p>
      <p class="nome-destaque">{{ categoriaSelecionada?.nome }}</p>
      <p class="aviso">Esta ação não pode ser desfeita.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="excluirCategoria()" [disabled]="carregando">
        {{ carregando ? 'Excluindo...' : 'Confirmar Exclusão' }}
      </button>
    </div>
  </div>
</div>

