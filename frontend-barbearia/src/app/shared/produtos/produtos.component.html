<div class="produtos-container">
  <!-- Header com Tabs -->
  <div class="header">
    <div class="header-left">
      <h1>üì¶ Gest√£o da Loja</h1>
      <div class="tabs">
        <button 
          class="tab"
          [class.active]="abaAtiva === 'produtos'"
          (click)="mudarAba('produtos')">
          Produtos
        </button>
        <button 
          class="tab"
          [class.active]="abaAtiva === 'categorias'"
          (click)="mudarAba('categorias')">
          Categorias
        </button>
      </div>
    </div>
    <button 
      class="btn btn-primary" 
      (click)="abaAtiva === 'produtos' ? abrirModalNovoProduto() : abrirModalNovaCategoria()">
      <span class="icon">‚ûï</span>
      {{ abaAtiva === 'produtos' ? 'Novo Produto' : 'Nova Categoria' }}
    </button>
  </div>

  <!-- Mensagens -->
  <div class="mensagem sucesso" *ngIf="sucesso">
    ‚úÖ {{ sucesso }}
  </div>

  <div class="mensagem erro" *ngIf="erro && !mostrarModalProduto && !mostrarModalCategoria">
    ‚ùå {{ erro }}
  </div>

  <!-- ==================== ABA PRODUTOS ==================== -->
  <div *ngIf="abaAtiva === 'produtos'">
    <!-- Filtros -->
    <div class="filtros-container">
      <div class="busca-box">
        <span class="icone-busca">üîç</span>
        <input 
          type="text" 
          [(ngModel)]="termoBuscaProduto" 
          (input)="aplicarFiltrosProdutos(); paginaAtualProdutos = 1"
          placeholder="Buscar produtos por nome, descri√ß√£o ou categoria..."
          class="input-busca">
        <button class="btn-limpar" (click)="limparFiltrosProdutos()" *ngIf="termoBuscaProduto">‚úñ</button>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" *ngIf="carregando && produtos.length === 0">
      <div class="spinner"></div>
      <p>Carregando produtos...</p>
    </div>

    <!-- Grid de Produtos -->
    <div class="produtos-grid" *ngIf="!carregando || produtos.length > 0">
      <div class="produto-card" *ngFor="let produto of produtosPaginados">
        <div class="produto-imagem">
          <img [src]="produto.foto_url || 'https://via.placeholder.com/300x200?text=Sem+Imagem'" 
               [alt]="produto.nome"
               (error)="onImageError($event)">
          <div class="produto-status" [class.inativo]="!produto.ativo">
            {{ produto.ativo ? 'Ativo' : 'Inativo' }}
          </div>
        </div>
        
        <div class="produto-info">
          <span class="produto-categoria" *ngIf="produto.categoria_nome">
            {{ produto.categoria_nome }}
          </span>
          <h3 class="produto-nome">{{ produto.nome }}</h3>
          <p class="produto-descricao" *ngIf="produto.descricao">
            {{ produto.descricao }}
          </p>
          
          <div class="produto-detalhes">
            <div class="preco-container">
              <span class="preco-label">Pre√ßo</span>
              <span class="preco">R$ {{ formatarPreco(produto.preco) }}</span>
            </div>
            <div class="estoque-container">
              <span class="estoque-label">Estoque</span>
              <span class="estoque" [class.baixo]="produto.estoque < 10">
                {{ produto.estoque }} un.
              </span>
            </div>
          </div>
        </div>

        <div class="produto-acoes">
          <button class="btn-acao editar" (click)="abrirModalEditarProduto(produto)" title="Editar">
            ‚úèÔ∏è
          </button>
          <button 
            class="btn-acao status" 
            [class.ativo]="produto.ativo"
            (click)="alternarStatusProduto(produto)" 
            [title]="produto.ativo ? 'Desativar' : 'Ativar'">
            {{ produto.ativo ? 'üëÅÔ∏è' : 'üö´' }}
          </button>
          <button class="btn-acao excluir" (click)="confirmarExclusaoProduto(produto)" title="Excluir">
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>

    <!-- Sem resultados -->
    <div class="sem-resultados" *ngIf="produtosPaginados.length === 0 && !carregando">
      <span class="icone">üì≠</span>
      <h3>Nenhum produto encontrado</h3>
      <p *ngIf="termoBuscaProduto">Tente ajustar os filtros de busca</p>
      <p *ngIf="!termoBuscaProduto">Clique em "Novo Produto" para cadastrar</p>
    </div>

    <!-- Pagina√ß√£o -->
    <div class="paginacao" *ngIf="totalPaginasProdutos > 1">
      <button 
        class="btn-pagina"
        [disabled]="paginaAtualProdutos === 1"
        (click)="paginaAtualProdutos = paginaAtualProdutos - 1">
        ‚Äπ
      </button>

      <span class="pagina-info">
        P√°gina {{ paginaAtualProdutos }} de {{ totalPaginasProdutos }}
      </span>

      <button 
        class="btn-pagina"
        [disabled]="paginaAtualProdutos === totalPaginasProdutos"
        (click)="paginaAtualProdutos = paginaAtualProdutos + 1">
        ‚Ä∫
      </button>
    </div>
  </div>

  <!-- ==================== ABA CATEGORIAS ==================== -->
  <div *ngIf="abaAtiva === 'categorias'">
    <!-- Filtros -->
    <div class="filtros-container">
      <div class="busca-box">
        <span class="icone-busca">üîç</span>
        <input 
          type="text" 
          [(ngModel)]="termoBuscaCategoria" 
          (input)="aplicarFiltrosCategorias(); paginaAtualCategorias = 1"
          placeholder="Buscar categorias por nome ou descri√ß√£o..."
          class="input-busca">
        <button class="btn-limpar" (click)="limparFiltrosCategorias()" *ngIf="termoBuscaCategoria">‚úñ</button>
      </div>
    </div>

    <!-- Tabela de Categorias -->
    <div class="table-container">
      <table class="categorias-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Descri√ß√£o</th>
            <th>Status</th>
            <th>Cadastrado em</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let categoria of categoriasPaginadas">
            <td class="categoria-nome">{{ categoria.nome }}</td>
            <td>{{ categoria.descricao || '-' }}</td>
            <td>
              <span class="badge" [class.ativo]="categoria.ativo" [class.inativo]="!categoria.ativo">
                {{ categoria.ativo ? 'Ativo' : 'Inativo' }}
              </span>
            </td>
            <td>{{ formatarData(categoria.criado_em!) }}</td>
            <td>
              <div class="acoes">
                <button class="btn-acao editar" (click)="abrirModalEditarCategoria(categoria)" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn-acao excluir" (click)="confirmarExclusaoCategoria(categoria)" title="Excluir">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Sem resultados -->
      <div class="sem-resultados" *ngIf="categoriasPaginadas.length === 0">
        <span class="icone">üì≠</span>
        <h3>Nenhuma categoria encontrada</h3>
        <p *ngIf="termoBuscaCategoria">Tente ajustar os filtros de busca</p>
        <p *ngIf="!termoBuscaCategoria">Clique em "Nova Categoria" para cadastrar</p>
      </div>
    </div>

    <!-- Pagina√ß√£o -->
    <div class="paginacao" *ngIf="totalPaginasCategorias > 1">
      <button 
        class="btn-pagina"
        [disabled]="paginaAtualCategorias === 1"
        (click)="paginaAtualCategorias = paginaAtualCategorias - 1">
        ‚Äπ
      </button>

      <span class="pagina-info">
        P√°gina {{ paginaAtualCategorias }} de {{ totalPaginasCategorias }}
      </span>

      <button 
        class="btn-pagina"
        [disabled]="paginaAtualCategorias === totalPaginasCategorias"
        (click)="paginaAtualCategorias = paginaAtualCategorias + 1">
        ‚Ä∫
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL PRODUTO ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalProduto" (click)="fecharModais()">
  <div class="modal-conteudo modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editandoProduto ? '‚úèÔ∏è Editar Produto' : '‚ûï Novo Produto' }}</h2>
      <button class="btn-fechar" (click)="fecharModais()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ‚ùå {{ erro }}
      </div>

      <div class="form-linha">
        <div class="form-grupo col-2">
          <label>Nome do Produto *</label>
          <input 
            type="text" 
            [(ngModel)]="formularioProduto.nome"
            placeholder="Ex: Corte Degrad√™"
            required>
        </div>

        <div class="form-grupo">
          <label>Categoria</label>
          <select [(ngModel)]="formularioProduto.categoria_id">
            <option [value]="undefined">Sem categoria</option>
            <option *ngFor="let cat of categorias" [value]="cat.id">
              {{ cat.nome }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-grupo">
        <label>Descri√ß√£o</label>
        <textarea 
          [(ngModel)]="formularioProduto.descricao"
          rows="3"
          placeholder="Descri√ß√£o detalhada do produto..."></textarea>
      </div>

      <div class="form-linha">
        <div class="form-grupo">
          <label>Pre√ßo (R$) *</label>
          <input 
            type="number" 
            [(ngModel)]="formularioProduto.preco"
            min="0"
            step="0.01"
            placeholder="0,00"
            required>
        </div>

        <div class="form-grupo">
          <label>Estoque</label>
          <input 
            type="number" 
            [(ngModel)]="formularioProduto.estoque"
            min="0"
            placeholder="0">
        </div>

        <div class="form-grupo" *ngIf="editandoProduto">
          <label>Status</label>
          <select [(ngModel)]="formularioProduto.ativo">
            <option [value]="true">Ativo</option>
            <option [value]="false">Inativo</option>
          </select>
        </div>
      </div>

      <div class="form-grupo">
        <label>URL da Foto (opcional)</label>
        <input 
          type="text" 
          [(ngModel)]="formularioProduto.foto_url"
          placeholder="https://exemplo.com/imagem.jpg">
        <small>Cole o link de uma imagem para o produto</small>
      </div>

      <div class="preview-imagem" *ngIf="formularioProduto.foto_url">
        <label>Preview:</label>
        <img 
          [src]="formularioProduto.foto_url" 
          alt="Preview"
          (error)="onImageError($event)">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarProduto()" [disabled]="carregando">
        {{ carregando ? 'Salvando...' : (editandoProduto ? 'Salvar Altera√ß√µes' : 'Cadastrar Produto') }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL CATEGORIA ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalCategoria" (click)="fecharModais()">
  <div class="modal-conteudo" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editandoCategoria ? '‚úèÔ∏è Editar Categoria' : '‚ûï Nova Categoria' }}</h2>
      <button class="btn-fechar" (click)="fecharModais()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ‚ùå {{ erro }}
      </div>

      <div class="form-grupo">
        <label>Nome da Categoria *</label>
        <input 
          type="text" 
          [(ngModel)]="formularoCategoria.nome"
          placeholder="Ex: Cortes de Cabelo"
          required>
      </div>

      <div class="form-grupo">
        <label>Descri√ß√£o</label>
        <textarea 
          [(ngModel)]="formularoCategoria.descricao"
          rows="3"
          placeholder="Descri√ß√£o da categoria..."></textarea>
      </div>

      <div class="form-grupo" *ngIf="editandoCategoria">
        <label>Status</label>
        <select [(ngModel)]="formularoCategoria.ativo">
          <option [value]="true">Ativo</option>
          <option [value]="false">Inativo</option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-primary" (click)="salvarCategoria()" [disabled]="carregando">
        {{ carregando ? 'Salvando...' : (editandoCategoria ? 'Salvar Altera√ß√µes' : 'Cadastrar Categoria') }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL EXCLUIR PRODUTO ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalExcluirProduto" (click)="fecharModais()">
  <div class="modal-conteudo modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ö†Ô∏è Confirmar Exclus√£o</h2>
      <button class="btn-fechar" (click)="fecharModais()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ‚ùå {{ erro }}
      </div>

      <p>Tem certeza que deseja excluir o produto:</p>
      <p class="nome-destaque">{{ produtoSelecionado?.nome }}</p>
      <p class="aviso">Esta a√ß√£o ir√° desativar o produto no sistema.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="excluirProduto()" [disabled]="carregando">
        {{ carregando ? 'Excluindo...' : 'Confirmar Exclus√£o' }}
      </button>
    </div>
  </div>
</div>

<!-- ==================== MODAL EXCLUIR CATEGORIA ==================== -->
<div class="modal-overlay" *ngIf="mostrarModalExcluirCategoria" (click)="fecharModais()">
  <div class="modal-conteudo modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ö†Ô∏è Confirmar Exclus√£o</h2>
      <button class="btn-fechar" (click)="fecharModais()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="mensagem erro" *ngIf="erro">
        ‚ùå {{ erro }}
      </div>

      <p>Tem certeza que deseja excluir a categoria:</p>
      <p class="nome-destaque">{{ categoriaSelecionada?.nome }}</p>
      <p class="aviso">Esta a√ß√£o n√£o pode ser desfeita.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="fecharModais()" [disabled]="carregando">
        Cancelar
      </button>
      <button class="btn btn-danger" (click)="excluirCategoria()" [disabled]="carregando">
        {{ carregando ? 'Excluindo...' : 'Confirmar Exclus√£o' }}
      </button>
    </div>
  </div>
</div>