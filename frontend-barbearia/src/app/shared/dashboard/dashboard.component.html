<div class="dashboard-container">
  <!-- HEADER -->
  <div class="header">
    <h1>ğŸ“Š Dashboard</h1>
    <p class="subtitle" *ngIf="!isFuncionario">VisÃ£o geral do seu negÃ³cio</p>
    <p class="subtitle" *ngIf="isFuncionario">HistÃ³rico dos seus atendimentos</p>
  </div>

  <!-- MENSAGEM -->
  <div *ngIf="mensagem" class="mensagem" [class.sucesso]="tipoMensagem === 'sucesso'" [class.erro]="tipoMensagem === 'erro'">
    {{ mensagem }}
  </div>

  <!-- LOADING ESTATÃSTICAS -->
  <div *ngIf="carregandoEstatisticas && !isFuncionario" class="loading">
    <div class="spinner"></div>
    <p>Carregando estatÃ­sticas...</p>
  </div>

  <!-- CARDS DE ESTATÃSTICAS (APENAS GERENTE) -->
  <div *ngIf="!carregandoEstatisticas && estatisticas && !isFuncionario" class="stats-grid">
    <!-- Card Dia -->
    <div class="stat-card card-blue">
      <div class="stat-icon">ğŸ“…</div>
      <div class="stat-info">
        <h3>Hoje</h3>
        <p class="stat-value">{{ formatarPreco(estatisticas.vendasDia.valor) }}</p>
        <p class="stat-label">{{ estatisticas.vendasDia.total }} vendas</p>
      </div>
    </div>

    <!-- Card Semana -->
    <div class="stat-card card-green">
      <div class="stat-icon">ğŸ“†</div>
      <div class="stat-info">
        <h3>Esta Semana</h3>
        <p class="stat-value">{{ formatarPreco(estatisticas.vendasSemana.valor) }}</p>
        <p class="stat-label">{{ estatisticas.vendasSemana.total }} vendas</p>
      </div>
    </div>

    <!-- Card MÃªs -->
    <div class="stat-card card-purple">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-info">
        <h3>Este MÃªs</h3>
        <p class="stat-value">{{ formatarPreco(estatisticas.vendasMes.valor) }}</p>
        <p class="stat-label">{{ estatisticas.vendasMes.total }} vendas</p>
      </div>
    </div>

    <!-- Card Ano -->
    <div class="stat-card card-orange">
      <div class="stat-icon">ğŸ“ˆ</div>
      <div class="stat-info">
        <h3>Este Ano</h3>
        <p class="stat-value">{{ formatarPreco(estatisticas.vendasAno.valor) }}</p>
        <p class="stat-label">{{ estatisticas.vendasAno.total}} vendas</p>
      </div>
    </div>
  </div>

  <!-- SERVIÃ‡OS MAIS VENDIDOS (APENAS GERENTE) -->
  <div *ngIf="!carregandoEstatisticas && estatisticas && !isFuncionario" class="ranking-grid">
    <!-- Top ServiÃ§os -->
    <div class="ranking-card">
      <h3>â­ ServiÃ§os Mais Vendidos (MÃªs)</h3>
      <div class="ranking-list">
        <div *ngFor="let servico of estatisticas.servicosMaisVendidos; let i = index" class="ranking-item">
          <span class="ranking-position">{{ i + 1 }}Âº</span>
          <span class="ranking-nome">{{ servico.servico_nome }}</span>
          <span class="ranking-quantidade">{{ servico.total_vendido }} vez(es)</span>
          <span class="ranking-valor">{{ formatarPreco(servico.valor_total) }}</span>
        </div>
        <div *ngIf="estatisticas.servicosMaisVendidos.length === 0" class="ranking-vazio">
          Nenhum serviÃ§o vendido este mÃªs
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS DE VENDAS -->
  <div class="filtros-section">
    <h2>ğŸ’° HistÃ³rico de Vendas</h2>
    
    <div class="filtros-container">
      <div class="filtro-grupo">
        <label>Tipo:</label>
        <select [(ngModel)]="filtroTipoVenda" (change)="aplicarFiltros()">
          <option value="TODOS">Todos</option>
          <option value="SERVICO">ServiÃ§os</option>
          <option value="PRODUTO">Produtos</option>
          <option value="MISTO">Misto</option>
        </select>
      </div>

      <div class="filtro-grupo">
        <label>PerÃ­odo:</label>
        <select [(ngModel)]="filtroPeriodo" (change)="aplicarFiltros()">
          <option value="TODOS">Todos</option>
          <option value="HOJE">Hoje</option>
          <option value="SEMANA">Ãšltima Semana</option>
          <option value="MES">Este MÃªs</option>
        </select>
      </div>

      <div class="filtro-grupo busca-grupo">
        <label>Buscar:</label>
        <input 
          type="text" 
          [(ngModel)]="termoBusca" 
          (input)="aplicarFiltros()"
          placeholder="Cliente ou funcionÃ¡rio..."
        />
      </div>

      <button class="btn-limpar-filtros" (click)="limparFiltros()">
        ğŸ—‘ï¸ Limpar
      </button>
    </div>
  </div>

  <!-- LOADING VENDAS -->
  <div *ngIf="carregandoVendas" class="loading">
    <div class="spinner"></div>
    <p>Carregando vendas...</p>
  </div>

  <!-- TABELA DE VENDAS -->
  <div *ngIf="!carregandoVendas" class="table-container">
    <table class="vendas-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Data/Hora</th>
          <th>Tipo</th>
          <th>Cliente</th>
          <th>FuncionÃ¡rio</th>
          <th>Valor</th>
          <th>Pagamento</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let venda of vendasPaginadas">
          <td>#{{ venda.id }}</td>
          <td>{{ formatarDataHora(venda.criado_em!) }}</td>
          <td>
            <span class="badge-tipo" [ngClass]="getTipoVendaClass(venda.tipo_venda)">
              {{ venda.tipo_venda }}
            </span>
          </td>
          <td>{{ venda.cliente_nome || 'N/A' }}</td>
          <td>{{ venda.funcionario_nome }}</td>
          <td class="valor">{{ formatarPreco(venda.valor_total) }}</td>
          <td>{{ venda.forma_pagamento }}</td>
          <td>
            <div class="acoes-grupo">
              <button 
                class="btn-acao btn-visualizar" 
                (click)="visualizarDetalhes(venda)"
                title="Ver Detalhes"
              >
                ğŸ‘ï¸
              </button>
              <button 
                *ngIf="!isFuncionario"
                class="btn-acao btn-editar" 
                (click)="editarVenda(venda)"
                title="Editar Venda"
              >
                âœï¸
              </button>
              <button 
                *ngIf="!isFuncionario"
                class="btn-acao btn-excluir" 
                (click)="confirmarExclusao(venda)"
                title="Excluir Venda"
              >
                ğŸ—‘ï¸
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="vendasFiltradas.length === 0" class="sem-resultados">
      <span class="icone">ğŸ”</span>
      <h3>Nenhuma venda encontrada</h3>
      <p>Tente ajustar os filtros</p>
    </div>
  </div>

  <!-- PAGINAÃ‡ÃƒO -->
  <div *ngIf="vendasFiltradas.length > 0" class="paginacao">
    <button 
      class="btn-pagina" 
      (click)="mudarPagina(paginaAtual - 1)"
      [disabled]="paginaAtual === 1"
    >
      â—€
    </button>
    
    <span class="pagina-info">
      PÃ¡gina {{ paginaAtual }} de {{ totalPaginas }} ({{ vendasFiltradas.length }} vendas)
    </span>
    
    <button 
      class="btn-pagina" 
      (click)="mudarPagina(paginaAtual + 1)"
      [disabled]="paginaAtual === totalPaginas"
    >
      â–¶
    </button>
  </div>
</div>

<!-- MODAL DE DETALHES DA VENDA -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="fecharModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header do Modal -->
    <div class="modal-header">
      <h2>ğŸ“‹ Detalhes da Venda #{{ vendaSelecionada?.id }}</h2>
      <button class="btn-fechar" (click)="fecharModal()">âœ–</button>
    </div>

    <!-- Loading -->
    <div *ngIf="carregandoDetalhes" class="modal-loading">
      <div class="spinner"></div>
      <p>Carregando detalhes...</p>
    </div>

    <!-- ConteÃºdo do Modal -->
    <div *ngIf="!carregandoDetalhes && vendaSelecionada" class="modal-body">
      <!-- InformaÃ§Ãµes Principais -->
      <div class="info-section">
        <h3>ğŸ“Š InformaÃ§Ãµes Gerais</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Data/Hora:</span>
            <span class="info-value">{{ formatarDataHora(vendaSelecionada.criado_em!) }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Tipo:</span>
            <span class="badge-tipo" [ngClass]="getTipoVendaClass(vendaSelecionada.tipo_venda)">
              {{ vendaSelecionada.tipo_venda }}
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Valor Total:</span>
            <span class="info-value destaque">{{ formatarPreco(vendaSelecionada.valor_total) }}</span>
          </div>
        </div>
      </div>

      <!-- Pessoas Envolvidas -->
      <div class="info-section">
        <h3>ğŸ‘¥ Pessoas</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">FuncionÃ¡rio:</span>
            <span class="info-value">{{ vendaSelecionada.funcionario_nome }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Cliente:</span>
            <span class="info-value">{{ vendaSelecionada.cliente_nome || 'N/A' }}</span>
          </div>
        </div>
      </div>

      <!-- Pagamento -->
      <div class="info-section">
        <h3>ğŸ’³ Pagamento</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Forma de Pagamento:</span>
            <span class="info-value">{{ vendaSelecionada.forma_pagamento }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status do Pagamento:</span>
            <span class="badge-status" [ngClass]="getStatusPagamentoClass(vendaSelecionada.status_pagamento)">
              {{ vendaSelecionada.status_pagamento }}
            </span>
          </div>
        </div>
      </div>

      <!-- ServiÃ§os -->
      <div class="info-section" *ngIf="vendaSelecionada.servicos && vendaSelecionada.servicos.length > 0">
        <h3>âœ‚ï¸ ServiÃ§os</h3>
        <table class="detalhes-table">
          <thead>
            <tr>
              <th>ServiÃ§o</th>
              <th>Qtd</th>
              <th>PreÃ§o Unit.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let servico of vendaSelecionada.servicos">
              <td>{{ servico.servico_nome }}</td>
              <td>{{ servico.quantidade }}</td>
              <td>{{ formatarPreco(servico.servico_preco) }}</td>
              <td>{{ formatarPreco(servico.subtotal) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Produtos -->
      <div class="info-section" *ngIf="vendaSelecionada.produtos && vendaSelecionada.produtos.length > 0">
        <h3>ğŸ“¦ Produtos</h3>
        <table class="detalhes-table">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Qtd</th>
              <th>PreÃ§o Unit.</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let produto of vendaSelecionada.produtos">
              <td>{{ produto.produto_nome }}</td>
              <td>{{ produto.quantidade }}</td>
              <td>{{ formatarPreco(produto.produto_preco) }}</td>
              <td>{{ formatarPreco(produto.subtotal) }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ObservaÃ§Ãµes -->
      <div class="info-section" *ngIf="vendaSelecionada.observacoes">
        <h3>ğŸ“ ObservaÃ§Ãµes</h3>
        <p class="observacoes-text">{{ vendaSelecionada.observacoes }}</p>
      </div>
    </div>

    <!-- Footer do Modal -->
    <div class="modal-footer">
      <button class="btn-secundario" (click)="fecharModal()">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL DE EDIÃ‡ÃƒO -->
<div class="modal-overlay" *ngIf="mostrarModalEdicao" (click)="fecharModalEdicao()">
  <div class="modal-content modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>âœï¸ Editar Venda #{{ vendaEdicao?.id }}</h2>
      <button class="btn-fechar" (click)="fecharModalEdicao()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="form-grupo">
        <label>Forma de Pagamento:</label>
        <select [(ngModel)]="vendaEdicao.forma_pagamento">
          <option value="DINHEIRO">Dinheiro</option>
          <option value="CARTAO_DEBITO">CartÃ£o DÃ©bito</option>
          <option value="CARTAO_CREDITO">CartÃ£o CrÃ©dito</option>
          <option value="PIX">PIX</option>
          <option value="OUTROS">Outros</option>
        </select>
      </div>

      <div class="form-grupo">
        <label>Status do Pagamento:</label>
        <select [(ngModel)]="vendaEdicao.status_pagamento">
          <option value="AGUARDANDO">Aguardando</option>
          <option value="PAGO">Pago</option>
          <option value="CANCELADO">Cancelado</option>
        </select>
      </div>

      <div class="form-grupo">
        <label>ObservaÃ§Ãµes:</label>
        <textarea 
          [(ngModel)]="vendaEdicao.observacoes"
          rows="4"
          placeholder="ObservaÃ§Ãµes sobre a venda..."
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secundario" (click)="fecharModalEdicao()" [disabled]="salvandoEdicao">
        Cancelar
      </button>
      <button class="btn-primario" (click)="salvarEdicao()" [disabled]="salvandoEdicao">
        {{ salvandoEdicao ? 'Salvando...' : 'Salvar' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMAÃ‡ÃƒO DE EXCLUSÃƒO -->
<div class="modal-overlay" *ngIf="mostrarModalExclusao" (click)="fecharModalExclusao()">
  <div class="modal-content modal-pequeno" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>âš ï¸ Confirmar ExclusÃ£o</h2>
      <button class="btn-fechar" (click)="fecharModalExclusao()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="aviso-exclusao">
        <p>Tem certeza que deseja excluir a venda #{{ vendaExclusao?.id }}?</p>
        <p class="aviso-destaque">âš ï¸ Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
        <div class="info-venda-exclusao">
          <p><strong>Cliente:</strong> {{ vendaExclusao?.cliente_nome || 'N/A' }}</p>
          <p><strong>FuncionÃ¡rio:</strong> {{ vendaExclusao?.funcionario_nome }}</p>
          <p><strong>Valor:</strong> {{ formatarPreco(vendaExclusao?.valor_total || 0) }}</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secundario" (click)="fecharModalExclusao()" [disabled]="excluindo">
        Cancelar
      </button>
      <button class="btn-perigo" (click)="excluirVenda()" [disabled]="excluindo">
        {{ excluindo ? 'Excluindo...' : 'Excluir' }}
      </button>
    </div>
  </div>
</div>
